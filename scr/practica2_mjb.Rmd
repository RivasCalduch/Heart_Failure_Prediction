---
title: "Practica 2: Data Cleaning"
author: "Jose Luis Rivas Calduch  y Mariano Jiménez Barca"
date: "30/11/2020"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: true
toc-title: Indice de contenidos
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, include=FALSE}

#Cargamos las diferentes librerias a emplear

#Lectura del fichero csv
library(readr)

#Libreria para representar graficos
library(ggpubr)
library(ggplot2)
library(psych)

#Libreria para el manejo de datos
library(dplyr)


```

### 1.- Descripción del Dataset

Este dataset recoge datos de pacientes reales que han sufrido un infarto de miocardio y que o bien han fallecido o bien han sobrevivido al cabo de un tiempo (recogido en la variable time).

Los datos que recoge el dataset nos informan de datos médicos en el momento del ataque y permite a priori crear modelos predictivos respecto a la probablidad de supervivencia de una persona tras un infarto de miocardio en función de sus datos analíticos.  

Permitiría preguntas de tipo ¿Es más probable que sobreviva un paciente fumador a un ataque al corazón? ¿Es más probable que sobreviva una persona de sexo femenino? ¿y una persona con diabetes?  

Los datos quizá también permitan generar un modelo predictivo que informara de cuáles son los pacientes más o menos probables de fallecer en función de una sere de condiciones: edad, concentración de creatinina en suero... y focalizarse más en este tipo de pacientes para tratar de aumentar la posibilidad de supervivencia.  

Los datos los podemos encontrar aqui: https://www.kaggle.com/andrewmvd/heart-failure-clinical-data. Los datos forman parte de un artículo publicado en el BMC Medical Informatics and Decision Making. EL artículo completo puede verse aquí: https://bmcmedinformdecismak.biomedcentral.com/articles/10.1186/s12911-020-1023-5#Tab8. Los autores del articulo son citados en el apartado agradecimientos.  


Las variables del dataset son:

age. Edad del paciente (en años)
anaemia. Si el paciente presenta anemia en el momento del infarto. Booleano (1/0).  
creatinine_phosphokinase. Nivel de CPK en sangre (en mcg/L).  
diabetes. Si el paciente presenta diabetes. Booleano (1/0).  
ejection_fraction. Porcentaje de la sangre que deja el corazón en cada contracción. (en tanto por ciento)
high_blood_pressure. Si el paciente presenta hipertensión. Booleano (1/0).   
platelets. Plaquetas en sangre. (en kiloplaquetas/mL).  
serum_creatinine. Nivel de creatinina en sangre (mg/dL).  
serum_sodium. Nivel de sodio en suero en sangre (mEq/L).  
sex. Hombre o mujer. Binario (w/m).  
smoking. Si el  paciente fuma o no. Booleano (1/0).  
time. periodo en días en que se hace seguimiento del paciente.  
DEATH_EVENT. Si el paciente fallece duante el periodo de seguimiento. Booleano (1/0).  



Carga del fichero.

```{r }

# carga del fichero
hf <- read.table("C:/Users/MAJIMENE/02.UOC/Master_Data_Science/Tipologia Datos/Practica2/heart_failure_clinical_records_dataset.csv", header= TRUE, sep=",", dec="." )

head(hf)

```








### 1.- ANALISIS



Dado el análisis de la información realizado sobre las variables nos planteamos tres análisis a realizar sobre los datos del dataset:

1.- Análisis de contraste respecto a si la media en días que tarda un paciente en morir depende de las condiciones que se presentan en variables no numéricas: si es fumador o no, el sexo, si tiene o no amemia, diabetes o presión elevada.

2.- Análisis de contraste respecto a si la probabilidad de morir depende de las condiciones que se presentan en variables no numéricas: si es fumador o no, el sexo, si tiene o no amemia, diabetes o presión elevada.

3.- Regresión logística para calcular si hay más probabilidad de morir que no en función de los parámetros médicos a la recepción del paciente. 


#### 5.1.- CONTRASTE DE HIPOTESIS


Segmentamos el datastet

```{r }

#Creación de subsets de trabajo de variables cualitativas anaemia, diabetes, high_blood_pressure


hf_sm <- hf[hf$smoking==1 ,]
hf_nosm<- hf[hf$smoking==0 ,]

hf_m<- hf[hf$sex==1 ,]
hf_w<- hf[hf$sex==0 ,]

hf_a<- hf[hf$anaemia==1 ,]
hf_noa<- hf[hf$anaemia==0 ,]

hf_d<- hf[hf$diabetes==1 ,]
hf_nod<- hf[hf$diabetes==0 ,]

hf_hp<- hf[hf$high_blood_pressure==1 ,]
hf_nohp<- hf[hf$high_blood_pressure==0 ,]

```

#### 5.1.1 - CONTRASTE SOBRE LA MEDIA EN FALLECER

PAra la realización del contraste necesitamos calcular previamente  la Media del tiempo en fallecer para cada subset creado.

```{r }
#cálculo de medias de tiempo en fallacer en función de variables diatomicas

# fumadores/no fumadores
sm <-hf_sm$time[hf_sm$DEATH_EVENT==1]
nosm <-hf_nosm$time[hf_nosm$DEATH_EVENT==1]

# hombre/mujer
m <-hf_m$time[hf_m$DEATH_EVENT==1]
w <-hf_w$time[hf_w$DEATH_EVENT==1]

# anemico/no anemico
a <-hf_a$time[hf_a$DEATH_EVENT==1]
noa <-hf_noa$time[hf_noa$DEATH_EVENT==1]

#diabetico/ no diabetico
d <-hf_d$time[hf_d$DEATH_EVENT==1]
nod <-hf_nod$time[hf_nod$DEATH_EVENT==1]

# hipertenso/no hipertenso
hp <-hf_hp$time[hf_hp$DEATH_EVENT==1]
nohp <-hf_nohp$time[hf_nohp$DEATH_EVENT==1]

# medias por fumar
c(mean(sm), mean(nosm))

#medias por sexo
c(mean(m), mean(w))

#medias por anemia
c(mean(a), mean(noa))

#medias por diabetes
c(mean(d), mean(nod))

#medias por hipertensión
c(mean(hp), mean(nohp))

#media total
mean(hf$time[hf$DEATH_EVENT==1])

```
A priori podríamos suponer que el tiempo medio que tarda en fallecer una persona sí depende de las variables cualitativas, pero realizamos el contraste estadístico.

Para ello en primer lugar sabemos que la media de una función con más de 30 muestras es normal por el teorema del límite central.

Las varianzas de las poblaciones son desconocidas pero sólo necesitamos saber si son iguales. Para ello realizamos un test de contraste de hipótesis de homocedasticidad. La hipótesis nula representa que las varianzas son iguales y la alternativa que las varianzas son diferentes.

Utilizamos la función var.test de R

https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/var.test

```{r}
# analisis de varianzas test de homocedasticidad


# fumadores/no fumadores
vsm<-var.test(sm,nosm, conf.level=0.95)
# sexo
vm<-var.test(m, w, conf.level=0.95)
#anémicos/no anemicos
va<-var.test(a,noa, conf.level=0.95)
# diabeticos/no diabeticos
vd<-var.test(d,nod, conf.level=0.95)
# hipertensos/no hipertensos
vhp<-var.test(hp,nohp, conf.level=0.95)

c(vsm[["p.value"]], vm[["p.value"]],va[["p.value"]],vd[["p.value"]],vhp[["p.value"]])

```

Dado que ningún p-value es menor que 0.05 no se puede rechazar la hipotesis nula en ninguno de los casos y por lo tanto las varianzas son iguales en todos los casos.  

Para realizar los contrastes estadísticos de las medias en cada caso debemos, dado que son muestras de población, utilizar la función de T Student con varianzas desconocidas pero iguales.  

Utilizamos la función de R t.test.  

https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/t.test

Por defecto trabajaremos con un nivel de confianza del 95% y por lo tanto un nivel de significación del 5% (0.05)

```{r }

#Contraste de hipótesis. Muestras poblacionales. Varianzas desconocidas pero iguales. Con un 95% de nivel de confianza

#fumadores/no fumadores
test_sm<-t.test(sm,nosm, alternative="two.sided", var.equal=TRUE, conf.level=0.95)
#sexo
test_m<-t.test(m, w, alternative="two.sided", var.equal=TRUE, conf.level=0.95)
#anémico/no anémico
test_a<-t.test(a,noa, alternative="two.sided", var.equal=TRUE, conf.level=0.95)
#diabetico/no diabetico
test_d<-t.test(d,nod, alternative="two.sided", var.equal=TRUE, conf.level=0.95)
#hipertenso/no hipertenso
test_hp<-t.test(hp,nohp, alternative="two.sided", var.equal=TRUE, conf.level=0.95)

c(test_sm[["p.value"]], test_m[["p.value"]],test_a[["p.value"]],test_d[["p.value"]],test_hp[["p.value"]])

```
En ninguno de los casos el p-value es menor que el nivel de significación (0.05). No pueden rechazarse ninguna de las hipótesis nulas y por lo tanto las medias de tiempo no son diferentes en ningún caso. 


#### 5.1.2 - CONTRASTE SOBRE LOS PORCENTAJES DE FALLECIDOS


Calculamos los porcentajes de fallecidos frente a los totales de cada muestra 

```{r}

# Estudio de porcentajes respecto a DEATH_EVENT

# totales
po<- nrow(hf[hf$DEATH_EVENT==1,])/nrow(hf)

# fumadores/no fumadores
psm<- nrow(hf_sm[hf_sm$DEATH_EVENT==1,])/nrow(hf_sm)
pnosm<- nrow(hf_nosm[hf_nosm$DEATH_EVENT==1,])/nrow(hf_nosm)

# sexo 
pm<- nrow(hf_m[hf_m$DEATH_EVENT==1,])/nrow(hf_m)
pw<- nrow(hf_w[hf_w$DEATH_EVENT==1,])/nrow(hf_w)

# anemicos/no amemicos
pa <- nrow(hf_a[hf_a$DEATH_EVENT==1,])/nrow(hf_a)
pnoa <- nrow(hf_noa[hf_noa$DEATH_EVENT==1,])/nrow(hf_noa)

# diabeticos/no diabeticos
pd <- nrow(hf_d[hf_d$DEATH_EVENT==1,])/nrow(hf_d)
pnod <- nrow(hf_nod[hf_nod$DEATH_EVENT==1,])/nrow(hf_nod)

# hipertensos/no hipertensos
php <- nrow(hf_hp[hf_hp$DEATH_EVENT==1,])/nrow(hf_hp)
pnohp <- nrow(hf_nohp[hf_nohp$DEATH_EVENT==1,])/nrow(hf_nohp)

#porcentajes en fumadores/no fumadores
c(psm,pnosm)

#porcentajes por sexo
c(pm,pw)

#porcentajes por anemicos/no anemicos
c(pa,pnoa)

#porcentajes por diabeticos/no diabeticos
c(pd,pnod)

#porcentajes por hipertensos/no hipertensos
c(php,pnohp)


```

Aunque los porcentajes ya se ven muy similares, vamos a realizar, igual que en el caso anterior, un contraste estadístico para cada variable en el que vamos a comparar el procentaje de fallecimientos:

- ser fumador frente a no ser fumador
- ser hombre frente a ser mujer 
- tener anemia frente a no tener anemia
- tener diabetes frente a no tener diabetes
- tener hipertensión frente a no tener hipertensión

la hipotesis nula en todos lo casos corresponde a que el porcentaje de fallecimientos en el primer caso  es igual al porcentaje de fallecimientos en el segundo. Es decir, que el porcentaje de fallecimentos es igual en el caso de ser fumador que no, ser hombre frente a ser mujer, etc...

La hipótesis alternativa sería que el porcentaje de fallecidos es diferente.

Se trata de contrastes bilaterales de proporciones de dos muestras.

Utilizamos la función de R prop.test 

https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/prop.test


```{r}

# Contraste de hipótesis para porcentajes


# fumador/no fumador
xsm<- c(nrow(hf_sm)*psm, nrow(hf_nosm)*pnosm)
nsm <- c(nrow(hf_sm), nrow(hf_nosm) )

prop_sm <- prop.test(xsm, nsm, alternative = "two.sided")

#sexo
xm<- c(nrow(hf_m)*pm, nrow(hf_w)*pw)
nm <- c(nrow(hf_m), nrow(hf_w) )

prop_m <- prop.test(xm, nm, alternative = "two.sided")

#anemico/no anémico
xa<- c(nrow(hf_a)*pa, nrow(hf_noa)*pnoa)
na <- c(nrow(hf_a), nrow(hf_noa) )

prop_a <- prop.test(xa, na, alternative = "two.sided")

#diabetico/no diabetico
xd<- c(nrow(hf_d)*pd, nrow(hf_nod)*pnod)
nd <- c(nrow(hf_d), nrow(hf_nod) )

prop_d <- prop.test(xd, nd, alternative = "two.sided")

#hipertenso/no hipertenso
xhp<- c(nrow(hf_hp)*php, nrow(hf_nohp)*pnohp)
nhp <- c(nrow(hf_hp), nrow(hf_nohp) )

prop_hp <- prop.test(xhp, nhp, alternative = "two.sided")


c(prop_sm[["p.value"]], prop_m[["p.value"]],prop_a[["p.value"]],prop_d[["p.value"]],prop_hp[["p.value"]])

```
De nuevo en todos los casos, p-value es superior al nivel de significación, por lo que no puede rechazarse la hipotesis nula. Los porcentajes de fallecidos en todos y cada uno de los casos son iguales.    

No hay diferencias con un nivel de confianza del 95% entre ser fumador o no o ser hombre/mujer o tener diabetes... a la hora de tener más probabilidad de fallecer tras un infarto, según la muestra de datos analizada.  



### 5.2 - MODELO DE REGRESION LOGISTICA. DIAGNOSTICO DE PROBABILIDAD DE FALLECIMIENTO  TRAS UN INFARTO


Para obtener un modelo que sirva para diagnosticar las probabilidades de supervivencia tras un infarto vamos a calcular un modelo logístico. El hecho de que la variable a predecir sea dicotómica nos impide utilizar un modelo lineal. Podríamos utilizar otros modelos de predicción (selección, clasificación) pero vamos a realizar un modelo logístico.  

Calcularemos inicialmente las variables que más intervienen en el modelo y posteriormente obtendremos una estimación de la seguridad del mismo. 

Dado que a priori no sabemos qué variables intervienen más en el modelo las incorporamos todas en el modelo.

La variable serum_creatinine, tal y como habíamos visto en apartados anteriores podemos normalizarla si aplicamos el logaritmo. 

```{r}

# modelo logístico

glm_hf1 <- glm(formula= factor(DEATH_EVENT)~ age + log(serum_creatinine) + ejection_fraction + (creatinine_phosphokinase) + serum_sodium + platelets + factor(sex) + factor(smoking) + factor(high_blood_pressure) + factor(diabetes) + anaemia , family=binomial(link=logit), data = hf)
summary(glm_hf1)
```
Interpretación modelo logístico:

El logit, es decir,  ln(P(Y=1/X)/1-P(Y=1/X)) es  4.18 + 5.093e-02 * age + 1.614 * log(serum_creatinine)  -6.48e-02 * ejection_fraction + 3.24e-04 * creatinine_phosphokinase 
  
Las variables cuyo p-value (Pr(>|z| del estadístico de Wald, z)  es mayor que el nivel de significación (0.05) no son significativas y no afectan al cálculo del logit)

AIC (Akaike Information Criterion) es el metodo matemático utilizado para calcular como de bueno es un modelo. Cuanto menor sea el valor de AIC mejor será el modelo.  

Se pueden calcular los Odds Ratio de cada variable como el exp de los coeficientes (por defecto con un intervalo de confianza al 95%).  

  

```{r 3.1.2.1}
exp(glm_hf1[["coefficients"]])
```
El odds ratio se relaciona con la probabilidad cruzada entre la variable independiente y la variable dependiente.

Cuando el odds ratio = 1 indica la no existencia de relación entre variables. 
Cuando el odds ratio > 1 indica que existe una relación entre variables y que incrementos en la variable independiente aumenta la probabilidad de ocurrir el evento (fallecimiento)
Cuando el odds ratio < 1 indica que existe una relación negativa. Es decir, incrementos de la variable independiente disminuye la probabilidad del evento (fallecimiento)  

Cuanto mayor (o menor) sea el valor del odds ratio respecto a 1 mayor será la variación de la probabilidad por cada unidad que aumente la variable, asi, para la variable age (por ejemplo), la relación es mayor que 1, y al ser variable continua, indica que por cada unidad que aumenta, el odds de DEATH_EVENT aumenta un 1.052. Es decir la probabilidad de fallecer dividido por la probabilidad de no fallecer es un 1.052 mayor.   

De cara a conocer cuáles son las variables a tener en cuenta en el modelo logístico hay que tener en cuenta, por tanto, el valor del odd ratio, el p valor y el AIC del modelo resultante. 

Creamos varios modelos y seleccionamos el que tiene el AIC menor

```{r}

# Determinación del modelo logístico

# en primer lugar con las variables significativas desde el punto de vista del p-value del estadístico de Wald
glm_hf2 <- glm(formula= factor(DEATH_EVENT)~ age + log(serum_creatinine) + ejection_fraction  + creatinine_phosphokinase, family=binomial(link=logit), data = hf)
glm_hf2 [["aic"]]
#vamos añadiendo variables numéricas de menor a mayor significancia
glm_hf3 <- glm(formula= factor(DEATH_EVENT)~ age +log(serum_creatinine) + ejection_fraction + creatinine_phosphokinase + serum_sodium, family=binomial(link=logit), data = hf)
glm_hf3 [["aic"]]

glm_hf4 <- glm(formula= factor(DEATH_EVENT)~ age + log(serum_creatinine) + ejection_fraction + creatinine_phosphokinase  + platelets, family=binomial(link=logit), data = hf)
glm_hf4 [["aic"]]

#añadimos ahora variables dicotómicas a partir del mejor modelo con variables numéricas
glm_hf5 <- glm(formula= factor(DEATH_EVENT)~ age + log(serum_creatinine) + ejection_fraction + creatinine_phosphokinase +  high_blood_pressure + anaemia, family=binomial(link=logit), data = hf)
glm_hf5 [["aic"]]

glm_hf6 <- glm(formula= factor(DEATH_EVENT)~ age + log(serum_creatinine) + ejection_fraction + creatinine_phosphokinase + serum_sodium + high_blood_pressure + anaemia + sex , family=binomial(link=logit), data = hf)
glm_hf6 [["aic"]]


```

El modelo que proporciona el AIC más bajo es el numero 5 que contempla las variables  age, log(serum_creatinine), ejection_fraction, creatinine_phosphokinase, high_blood_pressure y anaemia.

El modelo obtenido ya nos proporciona unos valores estimados que podemos comparar con los reales. En fitted.values se encuentra la probabilidad (como el exp(logit)/(1+exp(logit))). Para valores mayores de 0.5 estimamos que la persona fallece y para los casos en que es menor la persona sobrevive. 


```{r}
#Exactitud del modelo estimado. Matriz de confusión

pred<- glm_hf5[["fitted.values"]]
pred <- data.frame(pred,hf$DEATH_EVENT,resul)
for (i in 1:nrow(pred)) {
  if (pred$pred[i] < 0.5){
  pred$pred[i] <- 0  
  }else{
  pred$pred[i] <- 1  
  }
}
names (pred) <- c("pred","real")

#matriz de confusión
confMatrix<-table(pred$pred, pred$real)

confMatrix

# precisión
(confMatrix[1,1]+confMatrix[2,2])/sum(t)


```

## 6 - CONCLUSIONES

Se ha realizado un análisis pormenorizado de cada variable del dataset, con mayor foco en la variable a discriminar. Este análisis visual ya nos informa de que las variables dicotómicas iban a tener poca capacidad predictiva o estadística.  

Se ha realizado una serie de contrastes estadísticos con dos preguntas a responder:

1) ¿Depende de factores como la anemia, hipertensión, sexo, ser fumador o no o diabetes para tener mayor tiempo medio de supervivencia en caso de un ataque al corazón?, La respuesta es NO. Ninguno de estos factores es significativo con un nivel de confianza del 95%.  

2) ¿Depende de factores como la anemia, hipertensión, sexo, ser fumador o no o diabetes para tener mayor probabilidad de fallecer en caso de un ataque al corazón? La respuesta también es NO. Ninguno de estos factores es significativo con un nivel de confianza del 95%.  

Posteriormente se ha realizado un modelo de regresión logística a partir de los datos (dado que la variable a predecir es dicotómica) para predecir si un paciente en el momento de producirse un ataque al corazón tiene más probabilidad o no (fijándola en el 50%) de que fallezca.  

El modelo de regresión logística nos indica que las variables más importantes que intervienen en el modelo son age, serum_creatinine, ejection_fraction, creatinine_phosphokinase, high_blood_pressure y anaemia. Estas dos últimas en muy pequeña proporción.  

El modelo desarrollado tiene una fiabilidad del 77% con un poco más del 50% de capacidad de discernimiento en pacientes con probabilidad de fallecer.  


## 7 - BIBLIOGRAFIA

*Subirats Maté, Laila; Pérez Trenard, Diego O.; Calvo González, Mireia (2019)* Introducción al ciclo de la vida de los datos. UOC.  
*Subirats Maté, Laila; Calvo González, Mireia (2019)* Web scraping. UOC.  
*Subirats Maté, Laila; Pérez Trenard, Diego O.; Calvo González, Mireia (2019)* Introducción a limpieza y análisis de los datos. UOC.  
*Hernández Orallo, José; Ramirez Quintana, M José; Ferri Ramírez, Cesar (2004)* Introducción a la Minería de Datos. PEARSON.  
*Gironés Roig, Jordi; Casas Roma, Jordi; Minguillon Alfonso, Julia; Caichuelas Quiles, Ramon (2017)* Minería de datos: Modelos y algoritmos. UOC.  
*Guillén Estany, Montserrat; Alonso Alonso, María Teresa (2020)* Modelos de Regresión Logística. UOC.

## 8 - AGRADECIMIENTOS DATASET

*Cita*
Davide Chicco, Giuseppe Jurman: Machine learning can predict survival of patients with heart failure from serum creatinine and ejection fraction alone. BMC Medical Informatics and Decision Making 20, 16 (2020). https://bmcmedinformdecismak.biomedcentral.com/articles/10.1186/s12911-020-1023-5

*License*
CC BY 4.0
